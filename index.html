<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fractured Engine</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      background: radial-gradient(circle at top, #17172b 0%, #050509 55%, #020208 100%);
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
    }

    /* Resource bar at top */
    #resourceBar {
      width: 100%;
      padding: 8px 16px;
      background: rgba(5, 5, 15, 0.9);
      border-bottom: 1px solid #222233;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      font-size: 14px;
    }

    .res-item {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .res-icon {
      font-size: 18px;
      opacity: 0.9;
    }

    .res-value {
      font-variant-numeric: tabular-nums;
      min-width: 80px;
      text-align: right;
    }

    .res-label {
      font-size: 11px;
      opacity: 0.7;
    }

    /* Main centered content */
    #gameRoot {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #gameInner {
      max-width: 760px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      text-align: center;
    }

    h1 {
      font-size: 18px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin: 4px 0 2px 0;
      opacity: 0.92;
    }

    #subtitle {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    .panel {
      border-radius: 8px;
      border: 1px solid rgba(60, 60, 90, 0.8);
      background: radial-gradient(circle at top, #171727 0%, #050510 60%);
      padding: 10px 12px;
      width: 100%;
      max-width: 540px;
      text-align: left;
      box-shadow: 0 0 16px rgba(0, 0, 0, 0.4);
    }

    .panel-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.85;
    }

    .panel-title span.icon {
      font-size: 16px;
      margin-right: 4px;
    }

    .panel-flavor {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    .row {
      margin-bottom: 6px;
      font-size: 12px;
    }

    .small {
      font-size: 11px;
      opacity: 0.78;
    }

    button {
      padding: 6px 10px;
      margin: 4px 4px 0 0;
      background: #181825;
      border: 1px solid #444466;
      color: #f5f5f5;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: transform 0.05s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 0 8px rgba(90, 130, 255, 0.4);
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .affordable {
      border-color: #91a5ff;
      box-shadow: 0 0 10px rgba(120, 160, 255, 0.65);
    }

    .inline-stat {
      font-variant-numeric: tabular-nums;
    }

    .hidden {
      display: none !important;
    }

    /* Generators */
    .gen-row {
      border-top: 1px solid rgba(70, 70, 110, 0.9);
      padding-top: 6px;
      margin-top: 6px;
    }

    .gen-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 3px;
    }

    .gen-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .gen-icon {
      font-size: 16px;
      opacity: 0.9;
    }

    .gen-name {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .gen-count {
      font-size: 11px;
      opacity: 0.8;
    }

    .gen-body {
      margin-bottom: 3px;
    }

    .gen-flavor {
      font-size: 10px;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .gen-actions {
      display: flex;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    /* Intro overlay */
    #introOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(40, 50, 120, 0.7) 0%, rgba(0, 0, 10, 0.95) 55%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #introModal {
      width: 90%;
      max-width: 480px;
      background: #050510;
      border-radius: 10px;
      border: 1px solid #444466;
      padding: 16px 18px;
      box-shadow: 0 0 20px rgba(10, 10, 40, 0.95);
      text-align: left;
    }

    #introTitle {
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 6px;
    }

    #introBody {
      font-size: 12px;
      line-height: 1.5;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    #introHint {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 10px;
    }

    #introModal button {
      width: 100%;
      margin-top: 4px;
    }

    /* Mobile adjustments */
    @media (max-width: 600px) {
      #gameInner {
        max-width: 100%;
      }

      .panel {
        max-width: 100%;
      }

      #resourceBar {
        font-size: 12px;
        gap: 10px;
      }

      .res-value {
        min-width: 70px;
      }
    }
  </style>
</head>
<body>
  <!-- Intro overlay (first time only) -->
  <div id="introOverlay" class="hidden">
    <div id="introModal">
      <div id="introTitle">Fractured Engine</div>
      <div id="introBody">
        The core that once held reality together has shattered.
        Its routines are gone, leaving only drifting Sparks in the dark.
        You are the new Architect, rebuilding from nothing by stitching together
        crude constructs until the engine remembers how to run itself.
      </div>
      <div id="introHint">
        Your work begins with simple generators.
        As the engine strengthens, deeper systems will reveal themselves.
      </div>
      <button id="introConfirmBtn">Begin reassembly</button>
    </div>
  </div>

  <!-- Resource bar -->
  <div id="resourceBar">
    <div class="res-item">
      <span class="res-icon">●</span>
      <span class="res-value inline-stat" id="sparksDisplay">0</span>
      <span class="res-label">Sparks</span>
    </div>
    <div class="res-item">
      <span class="res-icon">⌘</span>
      <span class="res-value inline-stat" id="stabilizersDisplay">0</span>
      <span class="res-label">Stabilizers</span>
    </div>
    <div class="res-item">
      <span class="res-icon">✶</span>
      <span class="res-value inline-stat" id="spsDisplay">0</span>
      <span class="res-label">Sparks per second</span>
    </div>
  </div>

  <!-- Main content -->
  <div id="gameRoot">
    <div id="gameInner">
      <div>
        <h1>Fractured Engine</h1>
        <div id="subtitle">Prototype build - let the engine run itself</div>
      </div>

      <!-- Generators panel -->
      <div class="panel" id="panelGenerators">
        <div class="panel-title">
          <span><span class="icon">◆</span> Construct Lattice</span>
        </div>
        <div class="panel-flavor">
          The first layer of the new engine. Simple constructs that coax Sparks into motion.
          Let them work. They will feel slow at first.
        </div>
        <div class="row small">
          Generators produce Sparks automatically. More complex constructs unlock as the engine stabilizes.
        </div>
        <div id="generatorsList"></div>
      </div>

      <!-- Stabilize panel (prestige) -->
      <div class="panel hidden" id="panelStabilize">
        <div class="panel-title">
          <span><span class="icon">⌘</span> Stabilization Cycle</span>
        </div>
        <div class="panel-flavor">
          Collapse this run into a cleaner pattern and store what the engine learned as Stabilizers.
        </div>
        <div class="row small">
          Resets Sparks and generators, but you keep Stabilizers and tuning.
        </div>
        <div class="row small">
          Raw progress toward next Stabilizer:
          <span id="stabilizeProgress" class="inline-stat">0.00</span>
        </div>
        <div class="row small">
          Actual yield on stabilize:
          <span id="stabilizePreview" class="inline-stat">0</span> Stabilizers
          (run total <span id="runTotalSparks" class="inline-stat">0</span> Sparks)
        </div>
        <button id="stabilizeBtn">Stabilize Flow</button>
      </div>

      <!-- Upgrades panel (Stabilizer upgrades) -->
      <div class="panel hidden" id="panelUpgrades">
        <div class="panel-title">
          <span><span class="icon">✦</span> Engine Tuning</span>
        </div>
        <div class="panel-flavor">
          Subtle changes in resonance shift how every construct behaves.
          Tuning is slow, but it echoes through all layers.
        </div>
        <div class="row small">
          Global Spark multiplier: x<span id="sparkMultText" class="inline-stat">1.00</span>
        </div>
        <div class="row small">
          <strong>Resonant Coils</strong><br>
          <span class="small">
            Spend 1 Stabilizer to increase all Spark gain by x1.2.
            Each adjustment raises the underlying hum of the engine.
          </span>
        </div>
        <div class="gen-actions">
          <button id="buySparkMultBtn">
            Tune Resonant Coils (cost 1 Stabilizer)
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------

    const SAVE_KEY = "fracturedEngineSave_v2";
    const INTRO_KEY = "fracturedEngineIntroSeen";

    // Generator tiers: at least 5 before prestige
    const generators = [
      {
        id: "c1",
        name: "Ember Conduits",
        shortLabel: "Conduit",
        icon: "◆",
        baseRate: 0.3,
        baseCost: 10,
        costGrowth: 1.15,
        unlockAtSparks: 0,
        flavor: "Thin channels that keep loose Sparks from drifting away."
      },
      {
        id: "c2",
        name: "Pulse Relays",
        shortLabel: "Relay",
        icon: "▶",
        baseRate: 2,
        baseCost: 120,
        costGrowth: 1.16,
        unlockAtSparks: 80,
        flavor: "Rhythmic arrays that turn static flows into steady pulses."
      },
      {
        id: "c3",
        name: "Flux Weavers",
        shortLabel: "Weaver",
        icon: "✺",
        baseRate: 10,
        baseCost: 900,
        costGrowth: 1.17,
        unlockAtSparks: 600,
        flavor: "Weave multiple streams of Sparks into a coherent current."
      },
      {
        id: "c4",
        name: "Core Looms",
        shortLabel: "Loom",
        icon: "▣",
        baseRate: 45,
        baseCost: 4800,
        costGrowth: 1.18,
        unlockAtSparks: 3200,
        flavor: "Massive frames that spin Sparks into dense, reusable patterns."
      },
      {
        id: "c5",
        name: "Singularity Seeds",
        shortLabel: "Seed",
        icon: "◎",
        baseRate: 200,
        baseCost: 24000,
        costGrowth: 1.19,
        unlockAtSparks: 16000,
        flavor: "Proto cores that bend local rules, feeding on their own output."
      }
    ];

    // ---------- STATE ----------

    const state = {
      sparks: 0,
      stabilizers: 0,
      sparkMultiplier: 1,
      totalSparksThisRun: 0,
      genCounts: new Array(generators.length).fill(0)
    };

    // ---------- UTILS ----------

    function formatNumber(x) {
      if (x >= 1e9) return x.toExponential(2);
      if (x >= 1e6) return (x / 1e6).toFixed(2) + "M";
      if (x >= 1e3) return (x / 1e3).toFixed(2) + "K";
      return x.toFixed(2);
    }

    function formatSmall(x) {
      if (x >= 100) return x.toFixed(0);
      if (x >= 10) return x.toFixed(1);
      return x.toFixed(2);
    }

    function genCost(index) {
      const gen = generators[index];
      return gen.baseCost * Math.pow(gen.costGrowth, state.genCounts[index]);
    }

    function sparksPerSecond() {
      let total = 0;
      generators.forEach((gen, i) => {
        total += state.genCounts[i] * gen.baseRate;
      });
      return total * state.sparkMultiplier;
    }

    function stabilizerRawGain() {
      // Raw decimal to show progress even before 1
      const base = Math.pow(state.totalSparksThisRun, 0.6) / 100;
      return base;
    }

    function stabilizerGainFloored() {
      return Math.floor(stabilizerRawGain());
    }

    // ---------- CORE LOGIC ----------

    function gainSparks(amount) {
      state.sparks += amount;
      state.totalSparksThisRun += amount;
    }

    function tick(dt) {
      const sps = sparksPerSecond();
      gainSparks(sps * dt);
    }

    function hardResetRun(keepMeta = true) {
      const keepStabs = keepMeta ? state.stabilizers : 0;
      const keepMult = keepMeta ? state.sparkMultiplier : 1;
      const keepGens = keepMeta ? state.genCounts.slice() : new Array(generators.length).fill(0);

      state.sparks = 0;
      state.totalSparksThisRun = 0;
      state.stabilizers = keepStabs;
      state.sparkMultiplier = keepMult;
      state.genCounts = keepGens;
    }

    function stabilize() {
      const gainInt = stabilizerGainFloored();
      if (gainInt <= 0) return;
      state.stabilizers += gainInt;
      hardResetRun(true);
      saveGame();
    }

    // ---------- UI BUILD ----------

    function buildGeneratorUI() {
      const list = document.getElementById("generatorsList");
      list.innerHTML = "";

      generators.forEach((gen, index) => {
        const row = document.createElement("div");
        row.className = "gen-row hidden";
        row.id = "genRow_" + gen.id;

        row.innerHTML = `
          <div class="gen-header">
            <div class="gen-left">
              <span class="gen-icon">${gen.icon}</span>
              <span class="gen-name">${gen.name}</span>
            </div>
            <div class="gen-count">
              Owned: <span id="genCount_${gen.id}" class="inline-stat">0</span>
            </div>
          </div>
          <div class="gen-body small">
            Produces <span class="inline-stat">${gen.baseRate.toFixed(2)}</span> Sparks per second each,
            scaled by tuning.<br>
            Cost: <span id="genCost_${gen.id}" class="inline-stat">${formatNumber(gen.baseCost)}</span> Sparks
          </div>
          <div class="gen-flavor">
            ${gen.flavor}
          </div>
          <div class="gen-actions">
            <button id="genBuy_${gen.id}">Construct ${gen.shortLabel}</button>
          </div>
        `;
        list.appendChild(row);
      });
    }

    // ---------- VISIBILITY & HIGHLIGHTS ----------

    function updateVisibility() {
      // Generator rows unlock as you progress
      generators.forEach((gen, index) => {
        const row = document.getElementById("genRow_" + gen.id);
        if (!row) return;

        const unlocked = state.totalSparksThisRun >= gen.unlockAtSparks || state.genCounts[index] > 0;
        if (unlocked) {
          row.classList.remove("hidden");
        }
      });

      // Count how many generator types are actually used
      let activeGenTypes = 0;
      generators.forEach((_, index) => {
        if (state.genCounts[index] > 0) activeGenTypes += 1;
      });

      const panelStabilize = document.getElementById("panelStabilize");
      const panelUpgrades = document.getElementById("panelUpgrades");

      // Unlock prestige after you are actually using at least 4 generator types,
      // or as a fallback once the run is huge
      const canSeePrestige =
        activeGenTypes >= 4 || state.totalSparksThisRun >= 50000 || state.stabilizers > 0;

      if (canSeePrestige) {
        panelStabilize.classList.remove("hidden");
      }

      // Upgrades visible once you ever have Stabilizers
      if (state.stabilizers > 0) {
        panelUpgrades.classList.remove("hidden");
      }
    }

    function toggleAffordable(element, canAfford) {
      if (!element) return;
      if (canAfford) {
        element.classList.add("affordable");
      } else {
        element.classList.remove("affordable");
      }
    }

    // ---------- UI UPDATE ----------

    function updateUI() {
      // Top bar
      document.getElementById("sparksDisplay").textContent = formatNumber(state.sparks);
      document.getElementById("stabilizersDisplay").textContent = formatNumber(state.stabilizers);
      document.getElementById("spsDisplay").textContent = formatNumber(sparksPerSecond());

      // Generators
      generators.forEach((gen, index) => {
        const countSpan = document.getElementById("genCount_" + gen.id);
        const costSpan = document.getElementById("genCost_" + gen.id);
        const button = document.getElementById("genBuy_" + gen.id);
        if (!countSpan || !costSpan || !button) return;

        const cost = genCost(index);
        countSpan.textContent = state.genCounts[index].toString();
        costSpan.textContent = formatNumber(cost);

        const canAfford = state.sparks >= cost;
        toggleAffordable(button, canAfford);
      });

      // Prestige panel
      const raw = stabilizerRawGain();
      const floored = stabilizerGainFloored();
      document.getElementById("stabilizeProgress").textContent = formatSmall(raw);
      document.getElementById("stabilizePreview").textContent = floored.toString();
      document.getElementById("runTotalSparks").textContent = formatNumber(state.totalSparksThisRun);

      const stabilizeBtn = document.getElementById("stabilizeBtn");
      const canStabilizeNow = floored > 0;
      toggleAffordable(stabilizeBtn, canStabilizeNow);
      stabilizeBtn.disabled = !canStabilizeNow;

      // Upgrades
      document.getElementById("sparkMultText").textContent = state.sparkMultiplier.toFixed(2);
      const buySparkMultBtn = document.getElementById("buySparkMultBtn");
      const canBuyMult = state.stabilizers >= 1;
      toggleAffordable(buySparkMultBtn, canBuyMult);

      updateVisibility();
    }

    // ---------- SAVE / LOAD ----------

    function saveGame() {
      const saveData = JSON.stringify(state);
      localStorage.setItem(SAVE_KEY, saveData);
    }

    function loadGame() {
      const raw = localStorage.getItem(SAVE_KEY);
      if (!raw) return false;
      try {
        const data = JSON.parse(raw);

        state.sparks = data.sparks ?? 0;
        state.stabilizers = data.stabilizers ?? 0;
        state.sparkMultiplier = data.sparkMultiplier ?? 1;
        state.totalSparksThisRun = data.totalSparksThisRun ?? 0;
        if (Array.isArray(data.genCounts)) {
          state.genCounts = data.genCounts.slice(0, generators.length);
          while (state.genCounts.length < generators.length) {
            state.genCounts.push(0);
          }
        } else {
          state.genCounts = new Array(generators.length).fill(0);
        }
        return true;
      } catch (e) {
        console.error("Save load failed", e);
        return false;
      }
    }

    // ---------- BUTTONS & INTRO ----------

    function setupButtons() {
      // Generator buy buttons
      generators.forEach((gen, index) => {
        const btn = document.getElementById("genBuy_" + gen.id);
        if (!btn) return;
        btn.onclick = () => {
          const cost = genCost(index);
          if (state.sparks >= cost) {
            state.sparks -= cost;
            state.genCounts[index] += 1;
            updateUI();
            saveGame();
          }
        };
      });

      const stabilizeBtn = document.getElementById("stabilizeBtn");
      stabilizeBtn.onclick = () => {
        stabilize();
        updateUI();
      };

      const multBtn = document.getElementById("buySparkMultBtn");
      multBtn.onclick = () => {
        if (state.stabilizers >= 1) {
          state.stabilizers -= 1;
          state.sparkMultiplier *= 1.2;
          updateUI();
          saveGame();
        }
      };

      const introBtn = document.getElementById("introConfirmBtn");
      introBtn.onclick = () => {
        const overlay = document.getElementById("introOverlay");
        overlay.classList.add("hidden");
        localStorage.setItem(INTRO_KEY, "1");
      };
    }

    function setupIntroOverlay() {
      const seen = localStorage.getItem(INTRO_KEY);
      const overlay = document.getElementById("introOverlay");
      if (!seen) {
        overlay.classList.remove("hidden");
      } else {
        overlay.classList.add("hidden");
      }
    }

    // ---------- MAIN LOOP ----------

    let lastTime = performance.now();

    function gameLoop(now) {
      const dt = (now - lastTime) / 1000;
      lastTime = now;

      tick(dt);
      updateUI();

      if (now % 1000 < 50) {
        saveGame();
      }

      requestAnimationFrame(gameLoop);
    }

    // ---------- INIT ----------

    buildGeneratorUI();
    const hadSave = loadGame();
    if (!hadSave) {
      // Give a tiny starting buffer so you can buy the first generator without clicking
      state.sparks = 10;
      state.totalSparksThisRun = 0;
    }
    setupButtons();
    setupIntroOverlay();
    updateUI();
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>
